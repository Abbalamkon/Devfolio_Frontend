<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DevFolio - Professional Portfolio Platform</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      :root {
        --primary: #2d3748;
        --primary-dark: #1a202c;
        --accent: #4299e1;
        --bg-primary: #ffffff;
        --bg-secondary: #f7fafc;
        --bg-hover: #edf2f7;
        --text-primary: #1a202c;
        --text-secondary: #718096;
        --border: #e2e8f0;
        --error: #e53e3e;
        --success: #48bb78;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
      }
      .app-container {
        max-width: 1280px;
        margin: 0 auto;
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: 275px;
        padding: 20px;
        border-right: 1px solid var(--border);
        position: sticky;
        top: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--bg-primary);
      }
      .logo {
        font-size: 28px;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 30px;
        padding: 12px;
      }
      .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        margin-bottom: 8px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
        font-weight: 500;
        transition: background 0.2s, color 0.2s;
      }
      .nav-item:hover {
        background: var(--bg-hover);
      }
      .nav-item.active {
        font-weight: 700;
        background: var(--primary);
        color: white;
      }
      .nav-icon {
        width: 24px;
        height: 24px;
        margin-right: 20px;
      }
      .add-project-btn {
        background: var(--accent);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.2s;
      }
      .add-project-btn:hover {
        background: #3182ce;
      }
      .user-profile-sidebar {
        margin-top: auto;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background 0.2s;
      }
      .user-profile-sidebar:hover {
        background: var(--bg-hover);
      }
      .user-avatar-small {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
        background: var(--bg-secondary);
      }
      .user-info-small {
        flex: 1;
      }
      .user-name-small {
        font-weight: 700;
        font-size: 15px;
      }
      .user-username-small {
        color: var(--text-secondary);
        font-size: 15px;
      }
      .main-content {
        flex: 1;
        max-width: 900px;
        background: var(--bg-secondary);
      }
      .header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(12px);
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.9);
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header h1 {
        font-size: 22px;
        font-weight: 800;
      }
      .auth-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary);
      }
      .auth-box {
        background: white;
        padding: 40px;
        border-radius: 16px;
        border: 1px solid var(--border);
        width: 100%;
        max-width: 450px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      .auth-logo {
        text-align: center;
        font-size: 32px;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 30px;
      }
      .auth-title {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 24px;
        text-align: center;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 15px;
      }
      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 15px;
        transition: border 0.2s;
      }
      .form-input:focus {
        outline: none;
        border-color: var(--accent);
      }
      .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        width: 100%;
      }
      .btn-accent {
        background: var(--accent);
        color: white;
      }
      .btn-light {
        background: var(--bg-hover);
        color: var(--text-primary);
        border: 1px solid var(--border);
      }
      .auth-link {
        text-align: center;
        margin-top: 20px;
        color: var(--text-secondary);
      }
      .auth-link a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 600;
      }
      .error-message {
        background: #fee;
        color: var(--error);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
      }
      .success-message {
        background: #efe;
        color: var(--success);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }
      .project-card {
        padding: 24px;
        border-bottom: 1px solid var(--border);
        background: white;
      }
      .project-card-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
      }
      .project-card-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
      }
      .project-card-author-name {
        font-weight: 700;
        cursor: pointer;
      }
      .project-card-author-name:hover {
        color: var(--accent);
      }
      .project-card-author-username {
        color: var(--text-secondary);
        font-size: 15px;
      }
      .project-card-title {
        font-size: 20px;
        font-weight: 700;
        margin: 8px 0;
      }
      .project-card-description {
        font-size: 15px;
        margin-bottom: 12px;
      }
      .project-links {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .project-link {
        padding: 6px 16px;
        background: var(--bg-secondary);
        border-radius: 20px;
        color: var(--accent);
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.2s;
      }
      .portfolio-page-content {
        padding: 24px;
        background: white;
      }
      .portfolio-section {
        margin-bottom: 32px;
      }
      .portfolio-section h2 {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 16px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 8px;
      }
      .portfolio-summary {
        font-size: 16px;
        line-height: 1.7;
      }
      .skills-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .skill-tag {
        padding: 6px 14px;
        background: var(--bg-hover);
        border-radius: 16px;
        font-size: 15px;
        font-weight: 500;
      }
      .featured-projects-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .profile-page-content {
        background: white;
      }
      .profile-header {
        position: relative;
      }
      .profile-cover {
        height: 200px;
        background-size: cover;
        background-position: center;
        background-color: var(--primary-dark);
      }
      .profile-info-section {
        padding: 20px;
      }
      .profile-avatar-section {
        margin-top: -75px;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }
      .profile-avatar {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        border: 4px solid white;
        object-fit: cover;
        background: var(--bg-secondary);
      }
      .profile-name {
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 4px;
      }
      .social-links {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      .social-link {
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        color: var(--text-primary);
        font-size: 15px;
      }
      .social-link svg {
        width: 20px;
        height: 20px;
        fill: var(--text-secondary);
      }
      .messages-container {
        display: flex;
        height: calc(100vh - 70px);
        background: white;
      }
      .conversations-list {
        width: 300px;
        border-right: 1px solid var(--border);
        overflow-y: auto;
      }
      .conversation-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
      }
      .conversation-item:hover {
        background: var(--bg-hover);
      }
      .conversation-item.active {
        background: var(--accent);
        color: white;
      }
      .conversation-item.active .conversation-username {
        color: white;
      }
      .conversation-username {
        font-weight: 600;
      }
      .chat-window {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .chat-header {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        font-weight: 700;
        font-size: 18px;
      }
      .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .message-bubble {
        max-width: 70%;
        padding: 10px 16px;
        border-radius: 20px;
      }
      .message-bubble.sent {
        background: var(--accent);
        color: white;
        align-self: flex-end;
      }
      .message-bubble.received {
        background: var(--bg-hover);
        align-self: flex-start;
      }
      .chat-input {
        display: flex;
        padding: 16px;
        border-top: 1px solid var(--border);
      }
      .chat-input input {
        flex: 1;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 20px;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .modal-title {
        font-size: 20px;
        font-weight: 800;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-primary);
      }
      .modal-body {
        padding: 20px;
        overflow-y: auto;
      }
      .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
      }
      #portfolioProjectList label {
        display: block;
        margin-bottom: 8px;
      }
      .image-upload-preview {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .image-preview {
        width: 100px;
        height: 100px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid var(--border);
      }
      .image-preview.avatar {
        border-radius: 50%;
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 768px) {
        .sidebar {
          width: 88px;
        }
        .nav-text,
        .user-info-small,
        .add-project-btn {
          display: none;
        }
      }
      @media (max-width: 600px) {
        .featured-projects-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Auth Pages -->
    <div id="loginPage" class="auth-container">
      <div class="auth-box">
        <div class="auth-logo">DevFolio</div>
        <h2 class="auth-title">Sign in to your Account</h2>
        <div id="loginError" class="error-message hidden"></div>
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input
              type="password"
              name="password"
              class="form-input"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Sign In</button>
        </form>
        <div class="auth-link">
          Don't have an account?
          <a href="#" onclick="showRegister()">Sign up</a>
        </div>
      </div>
    </div>

    <div id="registerPage" class="auth-container hidden">
      <div class="auth-box">
        <div class="auth-logo">DevFolio</div>
        <h2 class="auth-title">Create your account</h2>
        <div id="registerError" class="error-message hidden"></div>
        <form id="registerForm">
          <div class="form-group">
            <label class="form-label">Full Name</label>
            <input type="text" name="name" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" name="username" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-input" required />
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input
              type="password"
              name="password"
              class="form-input"
              required
              minlength="6"
            />
          </div>
          <button type="submit" class="btn btn-primary">Sign Up</button>
        </form>
        <div class="auth-link">
          Already have an account? <a href="#" onclick="showLogin()">Sign in</a>
        </div>
      </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">DevFolio</div>
        <nav>
          <div
            id="nav-myPortfolio"
            class="nav-item"
            onclick="showPage('myPortfolio')"
          >
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M12 5.9c1.16 0 2.1.94 2.1 2.1s-.94 2.1-2.1 2.1S9.9 9.16 9.9 8s.94-2.1 2.1-2.1m0 9c2.97 0 6.1 1.46 6.1 2.1v1.1H5.9V17c0-.64 3.13-2.1 6.1-2.1M12 4C9.79 4 8 5.79 8 8s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 9c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"
              />
            </svg>
            <span class="nav-text">My Portfolio</span>
          </div>
          <div id="nav-profile" class="nav-item" onclick="viewMyProfile()">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
              />
            </svg>
            <span class="nav-text">My Profile</span>
          </div>
          <div
            id="nav-projects"
            class="nav-item active"
            onclick="showPage('projects')"
          >
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"
              />
            </svg>
            <span class="nav-text">Projects</span>
          </div>
          <div
            id="nav-messages"
            class="nav-item"
            onclick="showPage('messages')"
          >
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
              />
            </svg>
            <span class="nav-text">Messages</span>
          </div>
        </nav>
        <button class="add-project-btn" onclick="openModal('addProjectModal')">
          Add Project
        </button>
        <div class="user-profile-sidebar" onclick="viewMyProfile()">
          <img src="" alt="User" class="user-avatar-small" id="sidebarAvatar" />
          <div class="user-info-small">
            <div class="user-name-small" id="sidebarName"></div>
            <div class="user-username-small" id="sidebarUsername"></div>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="main-content">
        <div id="myPortfolioPage" class="hidden">
          <div class="header">
            <h1>My Portfolio</h1>
            <button class="btn btn-accent" onclick="openEditPortfolioModal()">
              Edit Portfolio
            </button>
          </div>
          <div
            id="portfolio-content-wrapper"
            class="portfolio-page-content"
          ></div>
        </div>

        <div id="projectsPage">
          <div class="header"><h1>Projects</h1></div>
          <div id="projectsContainer"></div>
        </div>

        <div id="profilePage" class="hidden">
          <div class="header"><h1 id="profileHeaderName">Profile</h1></div>
          <div id="profile-content-wrapper"></div>
        </div>

        <div id="messagesPage" class="hidden">
          <div class="header"><h1>Messages</h1></div>
          <div class="messages-container">
            <div class="conversations-list" id="conversationsList"></div>
            <div class="chat-window" id="chatWindow"></div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modals -->
    <div id="addProjectModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Add New Project</h2>
          <button class="modal-close" onclick="closeModal('addProjectModal')">
            √ó
          </button>
        </div>
        <form id="addProjectForm">
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Project Title</label>
              <input type="text" name="title" class="form-input" required />
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea
                name="description"
                class="form-input"
                required
                rows="4"
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Demo Link</label>
              <input type="url" name="demo_url" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">GitHub Link</label>
              <input type="url" name="github_url" class="form-input" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-accent">Add Project</button>
          </div>
        </form>
      </div>
    </div>

    <div id="editPortfolioModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Edit Your Portfolio</h2>
          <button
            class="modal-close"
            onclick="closeModal('editPortfolioModal')"
          >
            √ó
          </button>
        </div>
        <form id="editPortfolioForm">
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Professional Summary</label>
              <textarea name="summary" class="form-input" rows="4"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Skills (comma-separated)</label>
              <textarea name="skills" class="form-input" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Featured Projects</label>
              <div id="portfolioProjectList"></div>
            </div>
            <div class="form-group">
              <label class="form-label">Work Experience</label>
              <textarea
                name="experience"
                class="form-input"
                rows="6"
                placeholder="e.g., Senior Developer @ ACME (2020-Present)"
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Education</label>
              <textarea
                name="education"
                class="form-input"
                rows="4"
                placeholder="e.g., B.S. in Computer Science"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-accent">Save Portfolio</button>
          </div>
        </form>
      </div>
    </div>

    <div id="editProfileModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Edit Profile</h2>
          <button class="modal-close" onclick="closeModal('editProfileModal')">
            √ó
          </button>
        </div>
        <form id="editProfileForm">
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Full Name</label>
              <input type="text" name="name" class="form-input" required />
            </div>
            <div class="form-group">
              <label class="form-label">Bio</label>
              <textarea name="bio" class="form-input" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Avatar URL</label>
              <input
                type="url"
                name="avatar_url"
                class="form-input"
                placeholder="https://example.com/avatar.jpg"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Cover Image URL</label>
              <input
                type="url"
                name="cover_image_url"
                class="form-input"
                placeholder="https://example.com/cover.jpg"
              />
            </div>
            <hr
              style="
                margin: 20px 0;
                border: 1px solid var(--border);
                border-top: 0;
              "
            />
            <div class="form-group">
              <label class="form-label">Email Address</label>
              <input type="email" name="email" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">GitHub URL</label>
              <input type="url" name="github" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">LinkedIn URL</label>
              <input type="url" name="linkedin" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">Twitter URL</label>
              <input type="url" name="twitter" class="form-input" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-accent">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <div id="messageModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="messageModalTitle">Send a Message</h2>
          <button class="modal-close" onclick="closeModal('messageModal')">
            √ó
          </button>
        </div>
        <form id="messageForm">
          <div class="modal-body">
            <input type="hidden" name="recipient_id" />
            <div class="form-group">
              <textarea
                name="message"
                class="form-input"
                rows="5"
                placeholder="Write your message..."
                required
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-accent">Send</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // API Configuration
      const API_URL = "https://devfoliobackend.netlify.app/api";
      let authToken = localStorage.getItem("authToken") || null;
      let currentUser = null;
      let allProjects = [];
      let userProjects = [];
      let currentRecipientId = null;

      // Helper: API Request
      async function apiRequest(endpoint, options = {}) {
        const config = {
          headers: {
            "Content-Type": "application/json",
            ...(authToken && { Authorization: `Bearer ${authToken}` }),
          },
          ...options,
        };

        try {
          const response = await fetch(`${API_URL}${endpoint}`, config);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "Request failed");
          }

          return data;
        } catch (error) {
          console.error("API Error:", error);
          throw error;
        }
      }

      // Show Error Message
      function showError(elementId, message) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.classList.remove("hidden");
        setTimeout(() => el.classList.add("hidden"), 5000);
      }

      // Show Success Message
      function showSuccess(message) {
        alert(message);
      }

      // Auth Functions
      window.addEventListener("DOMContentLoaded", async () => {
        if (authToken) {
          try {
            await loadCurrentUser();
            showMainApp();
          } catch (error) {
            localStorage.removeItem("authToken");
            authToken = null;
            document.getElementById("loginPage").classList.remove("hidden");
          }
        } else {
          document.getElementById("loginPage").classList.remove("hidden");
        }
      });

      const showLogin = () => {
        document.getElementById("loginPage").classList.remove("hidden");
        document.getElementById("registerPage").classList.add("hidden");
      };

      const showRegister = () => {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("registerPage").classList.remove("hidden");
      };

      // Login
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const credentials = {
            email: formData.get("email"),
            password: formData.get("password"),
          };

          try {
            const response = await apiRequest("/auth/login", {
              method: "POST",
              body: JSON.stringify(credentials),
            });

            authToken = response.data.token;
            localStorage.setItem("authToken", authToken);
            currentUser = response.data.user;

            showMainApp();
          } catch (error) {
            showError("loginError", error.message || "Login failed");
          }
        });

      // Register
      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const userData = {
            name: formData.get("name"),
            username: formData.get("username"),
            email: formData.get("email"),
            password: formData.get("password"),
          };

          try {
            const response = await apiRequest("/auth/register", {
              method: "POST",
              body: JSON.stringify(userData),
            });

            authToken = response.data.token;
            localStorage.setItem("authToken", authToken);
            currentUser = response.data.user;

            showMainApp();
          } catch (error) {
            showError("registerError", error.message || "Registration failed");
          }
        });

      // Load Current User
      async function loadCurrentUser() {
        const response = await apiRequest("/auth/me");
        currentUser = response.data;
        return currentUser;
      }

      // Show Main App
      async function showMainApp() {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("registerPage").classList.add("hidden");
        document.getElementById("mainApp").classList.remove("hidden");

        await loadApp();
      }

      // Load App Data
      async function loadApp() {
        loadSidebarProfile();
        await fetchProjects();
        await fetchMyPortfolio();
        showPage("projects");
      }

      // Load Sidebar Profile
      function loadSidebarProfile() {
        document.getElementById("sidebarName").textContent = currentUser.name;
        document.getElementById(
          "sidebarUsername"
        ).textContent = `@${currentUser.username}`;
        document.getElementById("sidebarAvatar").src =
          currentUser.avatar_url || "https://via.placeholder.com/40";
      }

      // Page Navigation
      function showPage(pageId) {
        [
          "myPortfolioPage",
          "projectsPage",
          "profilePage",
          "messagesPage",
        ].forEach((p) => document.getElementById(p).classList.add("hidden"));
        document.getElementById(`${pageId}Page`).classList.remove("hidden");

        [
          "nav-myPortfolio",
          "nav-profile",
          "nav-projects",
          "nav-messages",
        ].forEach((n) => document.getElementById(n).classList.remove("active"));
        document.getElementById(`nav-${pageId}`).classList.add("active");

        if (pageId === "messages") {
          loadConversations();
        } else if (pageId === "myPortfolio") {
          fetchMyPortfolio();
        }
      }

      // Fetch Projects
      async function fetchProjects() {
        try {
          const response = await apiRequest("/projects");
          allProjects = response.data;
          renderProjects(allProjects);
        } catch (error) {
          console.error("Failed to load projects:", error);
          document.getElementById("projectsContainer").innerHTML =
            '<div class="loading">Failed to load projects</div>';
        }
      }

      // Render Projects
      function renderProjects(projects) {
        const container = document.getElementById("projectsContainer");

        if (projects.length === 0) {
          container.innerHTML = '<div class="loading">No projects yet</div>';
          return;
        }

        container.innerHTML = projects
          .map(
            (p) => `
          <div class="project-card">
            <div class="project-card-header">
              <img src="${
                p.author.avatar_url || "https://via.placeholder.com/48"
              }" 
                   alt="${p.author.name}" 
                   class="project-card-avatar" 
                   onclick="viewProfile('${p.author.username}')" 
                   style="cursor:pointer;">
              <div>
                <div class="project-card-author-name" 
                     onclick="viewProfile('${p.author.username}')">
                  ${p.author.name}
                </div>
                <div class="project-card-author-username">@${
                  p.author.username
                }</div>
              </div>
            </div>
            <h2 class="project-card-title">${p.title}</h2>
            <p class="project-card-description">${p.description}</p>
            <div class="project-links">
              ${
                p.demo_url
                  ? `<a href="${p.demo_url}" class="project-link" target="_blank">üîó Demo</a>`
                  : ""
              }
              ${
                p.github_url
                  ? `<a href="${p.github_url}" class="project-link" target="_blank">üíª GitHub</a>`
                  : ""
              }
              ${
                p.author.username !== currentUser.username
                  ? `<a href="#" class="project-link" onclick="openMessageModal('${p.author.id}', '${p.author.name}')">‚úâÔ∏è Message</a>`
                  : ""
              }
            </div>
          </div>
        `
          )
          .join("");
      }

      // Fetch My Portfolio
      async function fetchMyPortfolio() {
        try {
          const response = await apiRequest("/portfolios/me/details");
          const portfolio = response.data;
          renderMyPortfolio(portfolio);
        } catch (error) {
          console.error("Failed to load portfolio:", error);
        }
      }

      // Render My Portfolio
      function renderMyPortfolio(portfolio) {
        const formatText = (text) =>
          text ? text.replace(/\n/g, "<br>") : "Not provided";
        const featured = portfolio.projects.filter((p) => p.is_featured);

        document.getElementById("portfolio-content-wrapper").innerHTML = `
          <div class="portfolio-section">
            <h2>Professional Summary</h2>
            <p class="portfolio-summary">${formatText(portfolio.summary)}</p>
          </div>
          <div class="portfolio-section">
            <h2>Skills</h2>
            <div class="skills-grid">
              ${(portfolio.skills || [])
                .map((s) => `<span class="skill-tag">${s}</span>`)
                .join("")}
            </div>
          </div>
          <div class="portfolio-section">
            <h2>Work Experience</h2>
            <div class="credential-item">${formatText(
              portfolio.experience
            )}</div>
          </div>
          <div class="portfolio-section">
            <h2>Education</h2>
            <div class="credential-item">${formatText(
              portfolio.education
            )}</div>
          </div>
          <div class="portfolio-section">
            <h2>Featured Projects</h2>
            <div class="featured-projects-grid">
              ${
                featured.length > 0
                  ? featured
                      .map(
                        (p) => `
                  <div class="project-card">
                    <h2 class="project-card-title">${p.title}</h2>
                    <p class="project-card-description">${p.description}</p>
                  </div>
                `
                      )
                      .join("")
                  : "<p>No featured projects yet.</p>"
              }
            </div>
          </div>
        `;
      }

      // View Profile
      async function viewProfile(username) {
        try {
          const response = await apiRequest(`/portfolios/${username}`);
          const data = response.data;
          renderProfilePage(data);
          showPage("profile");
        } catch (error) {
          console.error("Failed to load profile:", error);
          showError("profileError", "Failed to load profile");
        }
      }

      // View My Profile
      function viewMyProfile() {
        viewProfile(currentUser.username);
      }

      // Render Profile Page
      function renderProfilePage(data) {
        const formatText = (text) =>
          text ? text.replace(/\n/g, "<br>") : "Not provided";
        const isOwnProfile = data.user.username === currentUser.username;

        document.getElementById("profileHeaderName").textContent =
          data.user.name;
        document.getElementById("profile-content-wrapper").innerHTML = `
          <div class="profile-page-content">
            <div class="profile-header">
              <div class="profile-cover" style="background-image: url('${
                data.user.cover_image_url || ""
              }')"></div>
              <div class="profile-info-section">
                <div class="profile-avatar-section">
                  <img src="${
                    data.user.avatar_url || "https://via.placeholder.com/140"
                  }" 
                       alt="Profile" 
                       class="profile-avatar">
                  ${
                    isOwnProfile
                      ? `<button class="btn btn-light" onclick="openEditProfileModal()">Edit Profile</button>`
                      : `<button class="btn btn-accent" onclick="openMessageModal('${data.user.id}', '${data.user.name}')">Message</button>`
                  }
                </div>
                <div class="profile-name">${data.user.name}</div>
                <div class="project-card-author-username">@${
                  data.user.username
                }</div>
                <p>${data.user.bio || ""}</p>
              </div>
            </div>
            <div class="portfolio-page-content">
              <div class="portfolio-section">
                <h2>Contact & Social Media</h2>
                <div class="social-links">
                  ${
                    data.socials.github
                      ? `<a href="${data.socials.github}" target="_blank" class="social-link">
                    <svg viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.5 11.5 0 0 1 12 5.8c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12 24 5.373 18.627 0 12 0z"/></svg>
                    <span>GitHub</span>
                  </a>`
                      : ""
                  }
                  ${
                    data.socials.linkedin
                      ? `<a href="${data.socials.linkedin}" target="_blank" class="social-link">
                    <svg viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                    <span>LinkedIn</span>
                  </a>`
                      : ""
                  }
                  ${
                    data.socials.twitter
                      ? `<a href="${data.socials.twitter}" target="_blank" class="social-link">
                    <svg viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.616 1.922 2.397 3.307 4.498 3.345-2.071 1.623-4.678 2.588-7.521 2.588-.49 0-.974-.03-1.451-.086 2.665 1.712 5.83 2.713 9.248 2.713 8.16 0 12.613-6.673 12.3-13.34 1.021-.734 1.886-1.65 2.583-2.686z"/></svg>
                    <span>Twitter</span>
                  </a>`
                      : ""
                  }
                </div>
              </div>
              <div class="portfolio-section">
                <h2>Professional Summary</h2>
                <p class="portfolio-summary">${formatText(data.summary)}</p>
              </div>
              <div class="portfolio-section">
                <h2>Skills</h2>
                <div class="skills-grid">
                  ${(data.skills || [])
                    .map((s) => `<span class="skill-tag">${s}</span>`)
                    .join("")}
                </div>
              </div>
              <div class="portfolio-section">
                <h2>Work Experience</h2>
                <div class="credential-item">${formatText(
                  data.experience
                )}</div>
              </div>
              <div class="portfolio-section">
                <h2>Education</h2>
                <div class="credential-item">${formatText(data.education)}</div>
              </div>
              <div class="portfolio-section">
                <h2>Featured Projects</h2>
                <div class="featured-projects-grid">
                  ${
                    data.featured_projects.length > 0
                      ? data.featured_projects
                          .map(
                            (p) => `
                      <div class="project-card">
                        <h2 class="project-card-title">${p.title}</h2>
                        <p class="project-card-description">${p.description}</p>
                      </div>
                    `
                          )
                          .join("")
                      : "<p>No featured projects yet.</p>"
                  }
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Modal Functions
      const closeModal = (modalId) =>
        document.getElementById(modalId).classList.remove("active");
      const openModal = (modalId) =>
        document.getElementById(modalId).classList.add("active");

      // Add Project
      document
        .getElementById("addProjectForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const projectData = {
            title: formData.get("title"),
            description: formData.get("description"),
            demo_url: formData.get("demo_url") || null,
            github_url: formData.get("github_url") || null,
          };

          try {
            await apiRequest("/projects", {
              method: "POST",
              body: JSON.stringify(projectData),
            });

            showSuccess("Project added successfully!");
            closeModal("addProjectModal");
            e.target.reset();
            await fetchProjects();
          } catch (error) {
            alert("Failed to add project: " + error.message);
          }
        });

      // Edit Portfolio Modal
      async function openEditPortfolioModal() {
        try {
          const response = await apiRequest("/portfolios/me/details");
          const portfolio = response.data;

          const form = document.getElementById("editPortfolioForm");
          form.querySelector('[name="summary"]').value =
            portfolio.summary || "";
          form.querySelector('[name="experience"]').value =
            portfolio.experience || "";
          form.querySelector('[name="education"]').value =
            portfolio.education || "";
          form.querySelector('[name="skills"]').value = (
            portfolio.skills || []
          ).join(", ");

          const projectList = document.getElementById("portfolioProjectList");
          projectList.innerHTML = portfolio.projects
            .map(
              (p) => `
            <label>
              <input type="checkbox" name="featured_projects" value="${p.id}" ${
                p.is_featured ? "checked" : ""
              }>
              ${p.title}
            </label>
          `
            )
            .join("");

          openModal("editPortfolioModal");
        } catch (error) {
          alert("Failed to load portfolio data");
        }
      }

      // Save Portfolio
      document
        .getElementById("editPortfolioForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          const portfolioData = {
            summary: formData.get("summary"),
            experience: formData.get("experience"),
            education: formData.get("education"),
            skills: formData
              .get("skills")
              .split(",")
              .map((s) => s.trim())
              .filter((s) => s),
            featured_projects: Array.from(formData.getAll("featured_projects")),
          };

          try {
            await apiRequest("/portfolios", {
              method: "PUT",
              body: JSON.stringify(portfolioData),
            });

            showSuccess("Portfolio updated successfully!");
            closeModal("editPortfolioModal");
            await fetchMyPortfolio();
          } catch (error) {
            alert("Failed to update portfolio: " + error.message);
          }
        });

      // Edit Profile Modal
      async function openEditProfileModal() {
        const form = document.getElementById("editProfileForm");
        form.querySelector('[name="name"]').value = currentUser.name;
        form.querySelector('[name="bio"]').value = currentUser.bio || "";
        form.querySelector('[name="avatar_url"]').value =
          currentUser.avatar_url || "";
        form.querySelector('[name="cover_image_url"]').value =
          currentUser.cover_image_url || "";
        form.querySelector('[name="email"]').value = currentUser.email || "";
        form.querySelector('[name="github"]').value =
          currentUser.socials?.github || "";
        form.querySelector('[name="linkedin"]').value =
          currentUser.socials?.linkedin || "";
        form.querySelector('[name="twitter"]').value =
          currentUser.socials?.twitter || "";

        openModal("editProfileModal");
      }

      // Save Profile
      document
        .getElementById("editProfileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          try {
            // Update profile
            const profileData = {
              name: formData.get("name"),
              bio: formData.get("bio"),
              avatar_url: formData.get("avatar_url"),
              cover_image_url: formData.get("cover_image_url"),
              email: formData.get("email"),
            };

            await apiRequest("/users/profile", {
              method: "PUT",
              body: JSON.stringify(profileData),
            });

            // Update socials
            const socialsData = {
              github: formData.get("github"),
              linkedin: formData.get("linkedin"),
              twitter: formData.get("twitter"),
            };

            await apiRequest("/users/socials", {
              method: "PUT",
              body: JSON.stringify(socialsData),
            });

            showSuccess("Profile updated successfully!");
            closeModal("editProfileModal");
            await loadCurrentUser();
            loadSidebarProfile();
            viewMyProfile();
          } catch (error) {
            alert("Failed to update profile: " + error.message);
          }
        });

      // Messaging Functions
      function openMessageModal(recipientId, recipientName) {
        currentRecipientId = recipientId;
        document.getElementById(
          "messageModalTitle"
        ).textContent = `Message ${recipientName}`;
        document
          .getElementById("messageForm")
          .querySelector('[name="recipient_id"]').value = recipientId;
        document
          .getElementById("messageForm")
          .querySelector('[name="message"]').value = "";
        openModal("messageModal");
      }

      // Send Message
      document
        .getElementById("messageForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          const messageData = {
            recipient_id: formData.get("recipient_id"),
            message: formData.get("message"),
          };

          try {
            await apiRequest("/messages", {
              method: "POST",
              body: JSON.stringify(messageData),
            });

            showSuccess("Message sent successfully!");
            closeModal("messageModal");
            showPage("messages");
          } catch (error) {
            alert("Failed to send message: " + error.message);
          }
        });

      // Load Conversations
      async function loadConversations() {
        try {
          const response = await apiRequest("/messages/conversations");
          const conversations = response.data;
          renderConversations(conversations);
        } catch (error) {
          console.error("Failed to load conversations:", error);
          document.getElementById("conversationsList").innerHTML =
            '<div class="loading">Failed to load conversations</div>';
        }
      }

      // Render Conversations
      function renderConversations(conversations) {
        const container = document.getElementById("conversationsList");

        if (conversations.length === 0) {
          container.innerHTML =
            '<div class="loading">No conversations yet</div>';
          return;
        }

        container.innerHTML = conversations
          .map(
            (conv) => `
          <div class="conversation-item" id="conv-${
            conv.user.id
          }" onclick="loadMessages('${conv.user.id}', '${conv.user.name}')">
            <img src="${
              conv.user.avatar_url || "https://via.placeholder.com/48"
            }" 
                 alt="${conv.user.name}" 
                 class="project-card-avatar">
            <div>
              <div class="conversation-username">${conv.user.name}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">
                ${conv.last_message.text.substring(0, 30)}...
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Load Messages
      async function loadMessages(userId, userName) {
        try {
          document
            .querySelectorAll(".conversation-item")
            .forEach((item) => item.classList.remove("active"));
          document.getElementById(`conv-${userId}`).classList.add("active");

          const response = await apiRequest(`/messages/${userId}`);
          const data = response.data;
          renderMessages(data, userId, userName);
        } catch (error) {
          console.error("Failed to load messages:", error);
        }
      }

      // Render Messages
      function renderMessages(data, userId, userName) {
        const chatWindow = document.getElementById("chatWindow");

        chatWindow.innerHTML = `
          <div class="chat-header">${userName}</div>
          <div class="chat-messages" id="chatMessages">
            ${data.messages
              .map(
                (msg) => `
              <div class="message-bubble ${
                msg.sent_by_me ? "sent" : "received"
              }">
                ${msg.message}
              </div>
            `
              )
              .join("")}
          </div>
          <div class="chat-input">
            <form id="replyForm" style="width:100%; display:flex;">
              <input type="hidden" name="recipient_id" value="${userId}">
              <input type="text" name="message" placeholder="Type a message..." class="form-input" autocomplete="off" required>
              <button type="submit" class="btn btn-accent" style="margin-left: 10px;">Send</button>
            </form>
          </div>
        `;

        const chatMessagesDiv = document.getElementById("chatMessages");
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

        // Reply Handler
        document
          .getElementById("replyForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
              await apiRequest("/messages", {
                method: "POST",
                body: JSON.stringify({
                  recipient_id: formData.get("recipient_id"),
                  message: formData.get("message"),
                }),
              });

              e.target.reset();
              await loadMessages(userId, userName);
            } catch (error) {
              alert("Failed to send message: " + error.message);
            }
          });
      }

      // Logout
      function logout() {
        localStorage.removeItem("authToken");
        authToken = null;
        currentUser = null;
        document.getElementById("mainApp").classList.add("hidden");
        document.getElementById("loginPage").classList.remove("hidden");
      }

      // Close modal on outside click
      window.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
          e.target.classList.remove("active");
        }
      });
    </script>
  </body>
</html>
